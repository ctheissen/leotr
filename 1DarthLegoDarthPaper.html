<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Leo's Opening Crawl</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
<!-- partial:index.partial.html -->
<section class="intro">
  A long time ago, on a spaceship called the PaperBrick....
</section>

<section class="logo">
      <img src="img/LeosStories.png">
</section>

<!-- Change the text to your liking -->
<div id="board">  
  <div id="content">
    <p id="episode">Episode I</p>
    <p id="title">TWO DARTHS</p>
    <br>
    <!-- And make it cheesy ! -->
    <p id='textbody'>There were two darths. One was named Darth Lego, for he was a Lego minifigure. The other was named Darth Paper, for he was made of paper. The two darths could not stop fighting. The darths were always fighting to show they were better. So their armies came together to make a plan on how to make them work together.</p> 
    <p id='textbody'>Their best plan was to make star destroyer blueprints because they both needed new warships. The blueprints were double-sided: one side was the Lego star destroyer, the other side was the paper star destroyer.</p> 
    <p id='textbody'>When the darths found out about it, instead of making peace, they decided to fight on who would have it. They fought over it until it ripped. The darths worked together to fix it, and for once, they didn't fight. But before they could build it, the potent Darth Later appears. He takes the blueprints, and then disappears....</p>        
  </div>  
</div>


  <audio id="audio">
        <source src="https://archive.org/download/StarWarsThemeSongByJohnWilliams/Star Wars Theme Song By John Williams.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
  </audio>

  <!-- Mute/Unmute Button -->
  <button id="muteBtn" class="mute-btn" title="Toggle Music">
    <svg id="volumeOnIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
      <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
    </svg>
    <svg id="volumeOffIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
      <line x1="23" y1="9" x2="17" y2="15"></line>
      <line x1="17" y1="9" x2="23" y2="15"></line>
    </svg>
  </button>

<script>
        var audio = document.getElementById('audio');
        var muteBtn = document.getElementById('muteBtn');
        var volumeOnIcon = document.getElementById('volumeOnIcon');
        var volumeOffIcon = document.getElementById('volumeOffIcon');
        // Default to muted on page load
        var isMuted = true;
        var fadeInterval = null;

        // Show mute icon only when explicitly muted, not when paused
        function updateMuteButton() {
            if (isMuted) {
                volumeOnIcon.style.display = 'none';
                volumeOffIcon.style.display = 'block';
            } else {
                volumeOnIcon.style.display = 'block';
                volumeOffIcon.style.display = 'none';
            }
        }

        // Ensure audio initial state reflects isMuted
        audio.muted = isMuted;
        // Reflect the icon immediately
        updateMuteButton();
        // Start at full volume unless user changed it elsewhere
        if (typeof audio.volume === 'number') audio.volume = audio.volume || 1;

        // Music start coordination:
        // - music only starts the first time LeosStories.png becomes visible
        // - enforce a minimum delay after page load because CSS shows the logo after ~8.5s
        // - if the user has explicitly muted when start conditions are reached, mark start as pending
        var musicStarted = false;
        var musicStartPending = false;
        var logoSeen = false;
        var pageLoadTs = Date.now();
        var minLogoDelayMs = 8100; // shortened from 9000 to 8500ms

        // Observe the logo image becoming visible
        var logoImg = document.querySelector('img[src*=\"LeosStories.png\"]');
        if (logoImg) {
            var io = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting && !logoSeen) {
                        // IntersectionObserver can fire before a CSS reveal finishes; record candidate and re-check timing
                        logoSeen = true;
                        io.disconnect();
                        tryStartMusicIfReady();
                    }
                });
            }, { threshold: 0.1 });
            io.observe(logoImg);
        } else {
            console.warn('LeosStories.png not found; adjust selector if needed');
        }

        function tryStartMusicIfReady() {
            if (musicStarted) return;
            if (!logoSeen) return;

            var elapsed = Date.now() - pageLoadTs;
            if (elapsed < minLogoDelayMs) {
                // Wait until the CSS animation time has passed; then attempt start again.
                setTimeout(tryStartMusicIfReady, minLogoDelayMs - elapsed + 50);
                return;
            }

            // If user explicitly muted, defer start until they unmute
            if (isMuted) {
                musicStartPending = true;
                return;
            }
            startMusicNow();
        }

        // Ensure audio.muted is set to the canonical isMuted before attempting playback.
        function startMusicNow() {
            if (musicStarted) return;
            // Do not start before the logo has been shown for the minimum time
            var elapsed = Date.now() - pageLoadTs;
            if (!logoSeen || elapsed < minLogoDelayMs) {
                musicStartPending = true;
                tryStartMusicIfReady();
                return;
            }

            musicStartPending = false;

            audio.muted = isMuted;

            audio.play().then(function() {
                musicStarted = true;
                scheduleFadeAfterMusicStart();
            }).catch(function(err) {
                console.warn('Autoplay prevented or play failed:', err);
                // If autoplay was blocked, a user gesture will be required to start playback.
            });
        }

        function scheduleFadeAfterMusicStart() {
            // Fade over ~60s (20 steps @ 3s) starting 72s after music starts.
            var fadeStartAfterMs = 72000;
            var fadeSteps = 20;
            var fadeStepDuration = 3000; // 3 seconds
            var decayFactor = 0.85;
            var currentStep = 0;

            // Clear any prior fade interval
            if (fadeInterval) {
                clearInterval(fadeInterval);
            }

            setTimeout(function() {
                fadeInterval = setInterval(function() {
                    currentStep++;
                    // Multiply current volume by decay factor so the fade adapts to user volume changes
                    audio.volume = Math.max(0, audio.volume * decayFactor);
                    if (currentStep >= fadeSteps) {
                        audio.volume = 0;
                        clearInterval(fadeInterval);
                    }
                }, fadeStepDuration);
            }, fadeStartAfterMs);
        }

        // Toggle mute and only start playback on unmute if the logo is visible and min delay has passed
        function toggleMute() {
            isMuted = !isMuted;
            audio.muted = isMuted;
            updateMuteButton();

            if (!isMuted) {
                // user unmuted — if logo is visible and min delay passed, try to start (this is a user gesture)
                var elapsed = Date.now() - pageLoadTs;
                if (logoSeen && elapsed >= minLogoDelayMs && !musicStarted) {
                    startMusicNow();
                } else if (logoSeen && elapsed < minLogoDelayMs) {
                    // mark pending; when min delay passes, tryStartMusicIfReady will handle it
                    musicStartPending = true;
                }
                if (musicStarted && audio.paused) {
                    audio.play().catch(function() {});
                }
            } else {
                // muted — if music is playing, mute immediately
                if (musicStarted && !audio.paused) {
                    audio.muted = true;
                }
            }
        }

        muteBtn.addEventListener('click', toggleMute);

        // If autoplay was blocked, start music on the first user gesture once the logo is visible and min delay passed.
        function bindUserStartGesture() {
            function onUserGesture() {
                var elapsed = Date.now() - pageLoadTs;
                if (logoSeen && elapsed >= minLogoDelayMs && !musicStarted) {
                    audio.muted = isMuted;
                    startMusicNow();
                } else if (logoSeen) {
                    musicStartPending = true;
                }
                document.removeEventListener('click', onUserGesture);
                document.removeEventListener('touchstart', onUserGesture);
            }
            document.addEventListener('click', onUserGesture, { once: true });
            document.addEventListener('touchstart', onUserGesture, { once: true });
        }

        bindUserStartGesture();

        // Ensure icons reflect initial state
        document.addEventListener('DOMContentLoaded', updateMuteButton);

    </script>    
</div>  

<!-- partial -->
  <script  src="./script.js"></script>

</body>
</html>